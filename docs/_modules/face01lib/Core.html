<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>face01lib.Core &mdash; FACE01  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> FACE01
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../face01lib.html">face01lib package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FACE01</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>face01lib.Core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for face01lib.Core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Reference</span>

<span class="sd">- &#39;cython&#39; compile option:</span>
<span class="sd">    - &#39;cython&#39; options which have enabled</span>
<span class="sd">        - &#39;cython&#39;: language_level=3</span>
<span class="sd">    - &#39;cython&#39; options not enabled</span>
<span class="sd">        - &#39;cython&#39;: profile = True</span>
<span class="sd">        - &#39;cython&#39;: boundscheck = False</span>
<span class="sd">        - &#39;cython&#39;: wraparound = False</span>
<span class="sd">        - &#39;cython&#39;: initializedcheck = False</span>
<span class="sd">        - &#39;cython&#39;: cdivision = True</span>
<span class="sd">        - &#39;cython&#39;: always_allow_keywords = False</span>
<span class="sd">        - &#39;cython&#39;: unraisable_tracebacks = False</span>
<span class="sd">        - &#39;cython&#39;: binding = False</span>

<span class="sd">- Data structure:</span>
<span class="sd">    - Definition of person_data_list and frame_datas_array:</span>
<span class="sd">        - overlay (npt.NDArray[np.uint8]): Copy of frame</span>
<span class="sd">        - face_location_list (List[Tuple[int,int,int,int]]): List of face_location</span>
<span class="sd">        - name (str): Each of person&#39;s name</span>
<span class="sd">        - filename (str): File name</span>
<span class="sd">        - percentage_and_symbol (str): Concatenate of digit of percentage and &#39;%&#39; symbol</span>
<span class="sd">        - person_data_list (List): List of person_data</span>
<span class="sd">        - frame_datas_array (List[Dict]): Array of frame_datas</span>
<span class="sd">        - resized_frame (npt.NDArray[np.uint8]): Numpy array of frame</span>

<span class="sd">        person_data = {</span>
<span class="sd">                &#39;name&#39;: name,</span>
<span class="sd">                &#39;pict&#39;:filename,</span>
<span class="sd">                &#39;date&#39;: date,</span>
<span class="sd">                &#39;location&#39;: (top,right,bottom,left),</span>
<span class="sd">                &#39;percentage_and_symbol&#39;: percentage_and_symbol</span>
<span class="sd">            }</span>
<span class="sd">        person_data_list.append(person_data)</span>

<span class="sd">        frame_datas = {</span>
<span class="sd">                &#39;img&#39;: resized_frame,</span>
<span class="sd">                &#39;face_location_list&#39;: face_location_list,</span>
<span class="sd">                &#39;overlay&#39;: overlay,</span>
<span class="sd">                &#39;person_data_list&#39;: person_data_list</span>
<span class="sd">            }</span>
<span class="sd">        frame_datas_array.append(frame_datas)</span>

<span class="sd">- About coordinate order:</span>
<span class="sd">    - dlib: (Left, Top, Right, Bottom,)</span>
<span class="sd">    - Dlib_api(): (top, right, bottom, left)</span>
<span class="sd">    - see bellow</span>
<span class="sd">        - https://github.com/davisking/dlib/blob/master/python_examples/faceapi.py</span>

<span class="sd">- References:</span>
<span class="sd">    - About usage of &#39;cython&#39;:</span>
<span class="sd">        - see bellow</span>
<span class="sd">            - https://www.youtube.com/watch?app=desktop&amp;v=sGggkVaRMzY</span>

<span class="sd">    - About mediapipe for python:</span>
<span class="sd">        - see bellow</span>
<span class="sd">            - https://github.com/google/mediapipe/tree/master/mediapipe/python</span>
<span class="sd">            - https://solutions.mediapipe.dev/face_detection#python-solution-api</span>

<span class="sd">    - About anti spoof function:</span>
<span class="sd">        - model</span>
<span class="sd">            - Original model create by Prokofev Kirill, modified by PINT</span>
<span class="sd">        - URL</span>
<span class="sd">            - https://github.com/PINTO0309/PINTO_model_zoo/tree/main/191_anti-spoof-mn3</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># from __future__ import annotations</span>


<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">move</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">format_exc</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">mediapipe</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">mojimoji</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>  <span class="c1"># See [](https://discuss.python.org/t/how-to-type-annotate-mathematical-operations-that-supports-built-in-numerics-collections-and-numpy-arrays/13509)</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span>
<span class="kn">from</span> <span class="nn">memory_profiler</span> <span class="kn">import</span> <span class="n">profile</span>  <span class="c1"># @profile()</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFile</span><span class="p">,</span> <span class="n">ImageFont</span>

<span class="kn">from</span> <span class="nn">face01lib.api</span> <span class="kn">import</span> <span class="n">Dlib_api</span>
<span class="kn">from</span> <span class="nn">face01lib.Calc</span> <span class="kn">import</span> <span class="n">Cal</span>
<span class="kn">from</span> <span class="nn">face01lib.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">face01lib.models</span> <span class="kn">import</span> <span class="n">Dlib_models</span>
<span class="kn">from</span> <span class="nn">face01lib.return_face_image</span> <span class="kn">import</span> <span class="n">Return_face_image</span>
<span class="kn">from</span> <span class="nn">face01lib.video_capture</span> <span class="kn">import</span> <span class="n">VidCap</span>


<span class="n">Cal_obj</span> <span class="o">=</span> <span class="n">Cal</span><span class="p">()</span>
<span class="n">VidCap_obj</span> <span class="o">=</span> <span class="n">VidCap</span><span class="p">()</span>
<span class="n">Dlib_api_obj</span> <span class="o">=</span> <span class="n">Dlib_api</span><span class="p">()</span>
<span class="n">Return_face_image_obj</span> <span class="o">=</span> <span class="n">Return_face_image</span><span class="p">()</span>

<span class="n">ImageFile</span><span class="o">.</span><span class="n">LOAD_TRUNCATED_IMAGES</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">anti_spoof_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Dlib_models</span><span class="p">()</span><span class="o">.</span><span class="n">anti_spoof_model_location</span><span class="p">()</span>
<span class="n">onnx_session</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">anti_spoof_model</span><span class="p">)</span>



<div class="viewcode-block" id="Core"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core">[docs]</a><span class="k">class</span> <span class="nc">Core</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Setup logger: common way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="kn">import</span> <span class="nn">os.path</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="vm">__name__</span>
        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">parent_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>


        <span class="n">Cal_obj</span><span class="o">.</span><span class="n">cal_specify_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.mp_face_detection_func"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.mp_face_detection_func">[docs]</a>    <span class="k">def</span> <span class="nf">mp_face_detection_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">model_selection</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">min_detection_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mp</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">solution_base</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;Processes an RGB image and returns a list of the detected face location data.</span>

<span class="sd">        Args:</span>
<span class="sd">            resized_frame (npt.NDArray[np.uint8]): Resized image frame</span>
<span class="sd">            model_selection (int, optional): Value set in &#39;config.ini&#39;.  Defaults to 0.</span>
<span class="sd">            min_detection_confidence (float, optional): Value set in &#39;config.ini&#39;. Defaults to 0.4.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NamedTuple object with a &quot;detections&quot; field that contains a list of the</span>
<span class="sd">            detected face location data.&#39;</span>

<span class="sd">        Refer:</span>
<span class="sd">            https://solutions.mediapipe.dev/face_detection#python-solution-api</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_selection</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_detection_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">min_detection_confidence</span>
        
        <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">        VidCap().frame_imshow_for_debug(self.resized_frame)</span>
<span class="sd">        print(type(self.resized_frame))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># method 1</span>
        <span class="c1"># mp_face_detection = mp.solutions.face_detection</span>
        <span class="c1"># with mp_face_detection.FaceDetection(</span>
        <span class="c1">#     self.model_selection[0],</span>
        <span class="c1">#     self.min_detection_confidence</span>
        <span class="c1"># ) as face_detection:</span>
        <span class="c1">#     results = face_detection.process(self.resized_frame)</span>

        <span class="c1"># method 2</span>
        <span class="n">f</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">solutions</span><span class="o">.</span><span class="n">face_detection</span><span class="o">.</span><span class="n">FaceDetection</span>  <span class="o">=</span> \
            <span class="n">mp</span><span class="o">.</span><span class="n">solutions</span><span class="o">.</span><span class="n">face_detection</span><span class="o">.</span><span class="n">FaceDetection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_detection_confidence</span>
        <span class="p">)</span>
        
        <span class="n">results</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">solution_base</span><span class="o">.</span><span class="n">SolutionOutputs</span> <span class="o">=</span> \
            <span class="n">f</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">        if not results.detections:</span>
<span class="sd">            exit(0)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;Reference</span>

<span class="sd">        https://solutions.mediapipe.dev/face_detection#python-solution-api</span>
<span class="sd">        </span>
<span class="sd">        Processes an RGB image and returns a list of the detected face location data.</span>

<span class="sd">        Args:</span>
<span class="sd">            image: An RGB image represented as a numpy ndarray.</span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the underlying graph throws any error.</span>
<span class="sd">        ValueError: </span>
<span class="sd">            If the input image is not three channel RGB.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A NamedTuple object with a &quot;detections&quot; field that contains a list of the</span>
<span class="sd">            detected face location data.&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">results</span></div>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_return_face_location_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">set_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">set_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">model_selection</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">min_detection_confidence</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">same_time_recognize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list_resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span><span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">set_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">set_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list_model_selection</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">model_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_detection_confidence</span> <span class="o">=</span> <span class="n">min_detection_confidence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">same_time_recognize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">same_time_recognize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list_resized_frame</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># person_frame = np.empty((2,0), dtype = np.float64)</span>
        <span class="c1"># date = datetime.now().strftime(&quot;%Y,%m,%d,%H,%M,%S,%f&quot;)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">solution_base</span><span class="o">.</span><span class="n">SolutionOutputs</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">mp_face_detection_func</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list_resized_frame</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list_model_selection</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">min_detection_confidence</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">face_location_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">detections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_time_recognize</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">xleft</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">location_data</span><span class="o">.</span><span class="n">relative_bounding_box</span><span class="o">.</span><span class="n">xmin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span><span class="p">)</span>
                <span class="n">xtop</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">location_data</span><span class="o">.</span><span class="n">relative_bounding_box</span><span class="o">.</span><span class="n">ymin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span><span class="p">)</span>
                <span class="n">xright</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">location_data</span><span class="o">.</span><span class="n">relative_bounding_box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span> <span class="o">+</span> <span class="n">xleft</span><span class="p">)</span>
                <span class="n">xbottom</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">location_data</span><span class="o">.</span><span class="n">relative_bounding_box</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span> <span class="o">+</span> <span class="n">xtop</span><span class="p">)</span>
                <span class="c1"># see bellow</span>
                <span class="c1"># https://stackoverflow.com/questions/71094744/how-to-crop-face-detected-via-mediapipe-in-python</span>
                
                <span class="k">if</span> <span class="n">xleft</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">xtop</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># xleft or xtop がマイナスになる場合があるとバグる</span>
                    <span class="k">continue</span>
                <span class="n">face_location_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xtop</span><span class="p">,</span><span class="n">xright</span><span class="p">,</span><span class="n">xbottom</span><span class="p">,</span><span class="n">xleft</span><span class="p">))</span>  <span class="c1"># Dlib_api() order</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="sd">&quot;&quot;&quot;DEBUG Memory leak&quot;&quot;&quot;</span>
        <span class="c1"># del result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">face_location_list</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_telop</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">cal_resized_telop_nums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cal_resized_telop_nums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cal_resized_telop_nums</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">x1</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">y2</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">a</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_resized_telop_nums</span>
        <span class="n">frame_view</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: #21 numpyのfunctionを探す</span>
            <span class="c1"># https://numpy.org/devdocs/reference/arrays.indexing.html</span>
            <span class="n">frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
            <span class="c1"># frame[:,y1:y2, x1:x2] = frame_view[:,y1:y2, x1:x2] * a + b</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cannot draw telop image&quot;</span><span class="p">)</span>
            <span class="c1"># TODO np.clip</span>
        <span class="k">return</span>  <span class="n">frame</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_logo</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">cal_resized_logo_nums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cal_resized_logo_nums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cal_resized_logo_nums</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">x1</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">y2</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">a</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_resized_logo_nums</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;logoが描画できません&quot;</span><span class="p">)</span>
            <span class="c1"># TODO np.clip</span>
        <span class="k">return</span> <span class="n">frame</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_check_compare_faces</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">known_face_encodings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="n">face_encoding</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
            <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return match list and min value using dlib_api</span>

<span class="sd">        Args:</span>
<span class="sd">            logger (_type_): logger</span>
<span class="sd">            known_face_encodings (List[npt.NDArray[np.float64]]): List of known face encodes</span>
<span class="sd">            face_encoding (npt.NDArray[np.float64]): Face encoding data to be compared</span>
<span class="sd">            tolerance (float): tolerance value</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[npt.NDArray[np.bool8], float]: match list, min value</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_face_encodings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">known_face_encodings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_encoding</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">matches</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">]</span>
            <span class="n">min_distance</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">matches</span><span class="p">,</span> <span class="n">min_distance</span> <span class="o">=</span>\
                <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">compare_faces</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">known_face_encodings</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">face_encoding</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">matches</span><span class="p">,</span> <span class="n">min_distance</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DEBUG: npKnown.npzが壊れているか予期しないエラーが発生しました。&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;npKnown.npzの自動削除は行われません。原因を特定の上、必要な場合npKnown.npzを削除して下さい。&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;処理を終了します。FACE01を再起動して下さい。&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;以下のエラーをシステム管理者様へお伝えください&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.make_frame_datas_array"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.make_frame_datas_array">[docs]</a>    <span class="k">def</span> <span class="nf">make_frame_datas_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">overlay</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]],</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">percentage_and_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">person_data_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
            <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Method to make frame_datas_array</span>

<span class="sd">        Return the data structure of frame_datas_list. </span>

<span class="sd">        Args:</span>
<span class="sd">            overlay (npt.NDArray[np.uint8]): Copy of frame</span>
<span class="sd">            face_location_list (List[Tuple[int,int,int,int]]): List of face_location</span>
<span class="sd">            name (str): Each of person&#39;s name</span>
<span class="sd">            filename (str): File name</span>
<span class="sd">            percentage_and_symbol (str): Concatenate of digit of percentage and &#39;%&#39; symbol</span>
<span class="sd">            person_data_list (List): List of person_data</span>
<span class="sd">            frame_datas_array (List[Dict]): Array of frame_datas</span>
<span class="sd">            resized_frame (npt.NDArray[np.uint8]): Numpy array of frame</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: List of frame_datas_array</span>

<span class="sd">        Example:</span>
<span class="sd">            - person_data:</span>
<span class="sd">            &gt;&gt;&gt;     {</span>
<span class="sd">            &gt;&gt;&gt;         &#39;name&#39;: name,</span>
<span class="sd">            &gt;&gt;&gt;         &#39;pict&#39;: filename,</span>
<span class="sd">            &gt;&gt;&gt;         &#39;date&#39;: date,</span>
<span class="sd">            &gt;&gt;&gt;         &#39;location&#39;: (top,right,bottom,left),</span>
<span class="sd">            &gt;&gt;&gt;         &#39;percentage_and_symbol&#39;: percentage_and_symbol</span>
<span class="sd">            &gt;&gt;&gt;     }</span>
<span class="sd">            </span>
<span class="sd">                person_data内のlocationは個々人の顔座標です。</span>
<span class="sd">                個々人を特定しない場合の顔座標はframe_datas[&#39;face_location_list&#39;]を使ってください。</span>

<span class="sd">            - person_data_list: </span>
<span class="sd">            &gt;&gt;&gt;    person_data_list.append(person_data)</span>
<span class="sd">            </span>
<span class="sd">            - frame_datas:</span>
<span class="sd">            &gt;&gt;&gt;    {</span>
<span class="sd">            &gt;&gt;&gt;        &#39;img&#39;: resized_frame,</span>
<span class="sd">            &gt;&gt;&gt;        &#39;face_location_list&#39;: face_location_list,</span>
<span class="sd">            &gt;&gt;&gt;        &#39;overlay&#39;: overlay,</span>
<span class="sd">            &gt;&gt;&gt;        &#39;person_data_list&#39;: person_data_list</span>
<span class="sd">            &gt;&gt;&gt;    }</span>

<span class="sd">            - frame_datas_list: </span>
<span class="sd">            &gt;&gt;&gt;     frame_datas_array.append(frame_datas)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">overlay</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">face_location_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_and_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">percentage_and_symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_data_list</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">person_data_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_datas_array</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_frame_datas_array_resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">face_location</span> <span class="ow">in</span> <span class="n">face_location_list</span><span class="p">:</span>
                <span class="c1"># person_data = {&#39;spoof_dict&#39;:{}, &#39;name&#39;: self.name, &#39;pict&#39;:self.filename,  &#39;date&#39;:date, &#39;location&#39;:face_location, &#39;percentage_and_symbol&#39;: self.percentage_and_symbol}</span>
                <span class="c1"># self.person_data_list.append(person_data)</span>
                <span class="n">frame_datas</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;img&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">make_frame_datas_array_resized_frame</span> <span class="p">,</span>
                    <span class="s1">&#39;face_location_list&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">face_location_list</span> <span class="p">,</span>
                    <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay</span> <span class="p">,</span>
                    <span class="s1">&#39;person_data_list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_data_list</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_datas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame_datas</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;img&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">make_frame_datas_array_resized_frame</span> <span class="p">,</span>
                <span class="s1">&#39;face_location_list&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">face_location_list</span> <span class="p">,</span>
                <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay</span> <span class="p">,</span>
                <span class="s1">&#39;person_data_list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_data_list</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_datas</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">        logger.debug(f&#39;frame_datas_array size: {len(self.frame_datas_array)}&#39;)</span>
<span class="sd">        logger.debug(inspect.currentframe().f_back.f_code.co_filename)</span>
<span class="sd">        logger.debug(inspect.currentframe().f_back.f_lineno)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span></div>


    <span class="c1"># pil_img_rgbオブジェクトを生成</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_pil_img_rgb_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">pil_img_obj_rgb</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGBA</span><span class="p">))</span>
        <span class="k">return</span>  <span class="n">pil_img_obj_rgb</span>

    <span class="c1"># 顔部分の領域をクロップ画像ファイルとして出力</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_make_crop_face_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">anti_spoof</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">dis</span><span class="p">,</span>
            <span class="n">pil_img_obj_rgb</span><span class="p">,</span>
            <span class="n">top</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span>
            <span class="n">bottom</span><span class="p">,</span>
            <span class="n">number_of_crops</span><span class="p">,</span>
            <span class="n">frequency_crop_image</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anti_spoof</span> <span class="o">=</span> <span class="n">anti_spoof</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dis</span> <span class="o">=</span> <span class="n">dis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj_rgb</span> <span class="o">=</span> <span class="n">pil_img_obj_rgb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_crops</span> <span class="o">=</span> <span class="n">number_of_crops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_crop_image</span> <span class="o">=</span> <span class="n">frequency_crop_image</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y,%m,</span><span class="si">%d</span><span class="s2">,%H,%M,%S,</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: CROPする時の余白を設定可能にする</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">imgCroped</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj_rgb</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">margin</span><span class="p">))</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># TODO: outputのファイル名にanti_spoof結果を入れる</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anti_spoof</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;output/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;output/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="p">)</span>
        <span class="n">imgCroped</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_crops</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_crop_image</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_return_face_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">matches</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">],</span>
            <span class="n">min_distance</span><span class="p">:</span> <span class="nb">float</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get face_name</span>

<span class="sd">        Args:</span>
<span class="sd">            CONFIG (Dict): CONFIG</span>
<span class="sd">            matches (npt.NDArray[np.bool8]): List of bool value</span>
<span class="sd">            min_distance (float): min value</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Name who is</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_distance</span> <span class="o">=</span> <span class="n">min_distance</span>

        <span class="c1"># アレイ中のインデックスからknown_face_names中の同インデックスの要素を算出</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;known_face_names&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_distance</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">file_name</span>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.return_concatenate_location_and_frame"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.return_concatenate_location_and_frame">[docs]</a>    <span class="k">def</span> <span class="nf">return_concatenate_location_and_frame</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return tuple </span>

<span class="sd">            - concatenate_face_location_list</span>
<span class="sd">            - concatenate_person_frame</span>

<span class="sd">        Args:</span>
<span class="sd">            resized_frame (npt.NDArray[np.uint8]): Resized frame</span>
<span class="sd">            face_location_list (List[Tuple[int,int,int,int]]): Face location list</span>

<span class="sd">        Returns:</span>
<span class="sd">            concatenate_face_location_list (Tuple[List[Tuple[int,int,int,int]])</span>
<span class="sd">                List of concatenated coordinates</span>
<span class="sd">            concatenate_person_frame (npt.NDArray[np.uint8]])</span>
<span class="sd">                Image data of concatenated person image data</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">return_concatenate_location_and_frame_resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list</span> <span class="o">=</span> <span class="n">face_location_list</span>

        <span class="sd">&quot;&quot;&quot;face_location_listはresized_frame上の顔座標&quot;&quot;&quot;</span>
        <span class="n">finally_height_size</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="n">concatenate_face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">detection_counter</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">person_frame_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">concatenate_person_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">xtop</span><span class="p">,</span><span class="n">xright</span><span class="p">,</span><span class="n">xbottom</span><span class="p">,</span><span class="n">xleft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_location_list</span><span class="p">:</span>
            <span class="n">person_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">return_concatenate_location_and_frame_resized_frame</span><span class="p">[</span><span class="n">xtop</span><span class="p">:</span><span class="n">xbottom</span><span class="p">,</span> <span class="n">xleft</span><span class="p">:</span><span class="n">xright</span><span class="p">]</span>
            
            <span class="c1"># person_frameをリサイズする</span>
            <span class="n">height</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">xbottom</span> <span class="o">-</span> <span class="n">xtop</span>
            <span class="n">width</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">xright</span> <span class="o">-</span> <span class="n">xleft</span>
            <span class="c1"># 拡大・縮小率を算出</span>
            <span class="n">fy</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="n">finally_height_size</span> <span class="o">/</span> <span class="n">height</span>
            <span class="n">finally_width_size</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">fy</span><span class="p">)</span>
            
            <span class="n">resized_person_frame</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Mat</span> <span class="o">=</span> \
                <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">person_frame</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="n">finally_width_size</span><span class="p">,</span> <span class="n">finally_height_size</span><span class="p">))</span>
            <span class="n">person_frame_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resized_person_frame</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">            cv2.imshow(&quot;DEBUG&quot;, person_frame)</span>
<span class="sd">            cv2.waitKey(5000)</span>
<span class="sd">            cv2.destroyAllWindows()</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># 拡大率に合わせて各座標を再計算する</span>
            <span class="c1">## person_frame上の各座標</span>
            <span class="n">person_frame_xtop</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">person_frame_xright</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">finally_width_size</span>
            <span class="n">person_frame_xbottom</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">finally_height_size</span>
            <span class="n">person_frame_xleft</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">## 連結されたperson_frame上の各座標</span>
            <span class="n">concatenated_xtop</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">person_frame_xtop</span>
            <span class="n">concatenated_xright</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">person_frame_xright</span> <span class="o">+</span> <span class="p">(</span><span class="n">finally_width_size</span> <span class="o">*</span> <span class="n">detection_counter</span><span class="p">)</span>
            <span class="n">concatenated_xbottom</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">person_frame_xbottom</span> 
            <span class="n">concatenated_xleft</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">person_frame_xleft</span> <span class="o">+</span> <span class="p">(</span><span class="n">finally_width_size</span> <span class="o">*</span> <span class="n">detection_counter</span><span class="p">)</span>

            <span class="n">concatenate_face_location_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">concatenated_xtop</span><span class="p">,</span><span class="n">concatenated_xright</span><span class="p">,</span><span class="n">concatenated_xbottom</span><span class="p">,</span><span class="n">concatenated_xleft</span><span class="p">))</span>  <span class="c1"># Dlib_api() order</span>
            <span class="n">detection_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="sd">&quot;&quot;&quot;about coordinate order</span>
<span class="sd">            dlib: (Left, Top, Right, Bottom,)</span>
<span class="sd">            Dlib_api(): (top, right, bottom, left)</span>
<span class="sd">            see bellow</span>
<span class="sd">            https://github.com/davisking/dlib/blob/master/python_examples/faceapi.py</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">concatenate_person_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">person_frame_list</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">            cv2.imshow(&quot;face_encodings&quot;, concatenate_person_frame)</span>
<span class="sd">            cv2.moveWindow(&quot;face_encodings&quot;, 800,600)</span>
<span class="sd">            cv2.waitKey(500)</span>
<span class="sd">            cv2.destroyAllWindows()</span>
<span class="sd">            exit(0)</span>
<span class="sd">            print(&quot;---------------------------------&quot;)</span>
<span class="sd">            print(f&#39;concatenate_face_location_list: {concatenate_face_location_list}&#39;)</span>
<span class="sd">            print(&quot;---------------------------------&quot;)</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">concatenate_face_location_list</span><span class="p">,</span> <span class="n">concatenate_person_frame</span></div>


    <span class="c1"># フレーム前処理</span>
    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.frame_pre_processing"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.frame_pre_processing">[docs]</a>    <span class="k">def</span> <span class="nf">frame_pre_processing</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return frame_datas_array</span>

<span class="sd">        Args:</span>
<span class="sd">            logger (_type_): logger</span>
<span class="sd">            CONFIG (Dict): Dict of Initial settings</span>
<span class="sd">            resized_frame (npt.NDArray[np.uint8]): Resized frame</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: frame_datas_array</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>

        <span class="n">person_data_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_and_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">overlay</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># 描画系（bottom area, 半透明, telop, logo）</span>
        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">## 半透明処理（前半）</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;show_overlay&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">overlay</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="sd">&quot;&quot;&quot;DEBUG: Memory leak&quot;&quot;&quot;</span>
                
            <span class="c1">## テロップとロゴマークの合成</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;draw_telop_and_logo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_draw_telop</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;cal_resized_telop_nums&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>
                        <span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_draw_logo</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;cal_resized_logo_nums&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>
                        <span class="p">)</span>

        <span class="c1"># 顔座標算出</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;use_pipe&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">face_location_list</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_return_face_location_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;set_width&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;set_height&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;model_selection&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;min_detection_confidence&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;same_time_recognize&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># date: str = datetime.now().strftime(&quot;%Y,%m,%d,%H,%M,%S,%f&quot;)  # Not use</span>
            <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_locations</span><span class="p">(</span>
                <span class="c1"># Dlib_api_obj.face_locations(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;upsampling&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># 顔がなかったら以降のエンコード処理を行わない</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">make_frame_datas_array</span><span class="p">(</span> 
                    <span class="n">overlay</span><span class="p">,</span>
                    <span class="n">face_location_list</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">filename</span><span class="p">,</span>
                    <span class="n">percentage_and_symbol</span><span class="p">,</span>
                    <span class="n">person_data_list</span><span class="p">,</span>
                    <span class="n">frame_datas_array</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">frame_datas_array</span>

        <span class="c1"># 顔が一定数以上なら以降の処理を行わない</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_people&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_people&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">人以上を検出しました&#39;</span><span class="p">)</span>
            <span class="n">frame_datas_array</span>  <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">make_frame_datas_array</span><span class="p">(</span>
                    <span class="n">overlay</span><span class="p">,</span>
                    <span class="n">face_location_list</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">filename</span><span class="p">,</span>
                    <span class="n">percentage_and_symbol</span><span class="p">,</span>
                    <span class="n">person_data_list</span><span class="p">,</span>
                    <span class="n">frame_datas_array</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">frame_datas_array</span>

        <span class="n">frame_datas</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;img&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span>
            <span class="s1">&#39;face_location_list&#39;</span><span class="p">:</span><span class="n">face_location_list</span><span class="p">,</span>
            <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
            <span class="s1">&#39;person_data_list&#39;</span><span class="p">:</span> <span class="n">person_data_list</span>
        <span class="p">}</span>

        <span class="n">frame_datas_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_datas</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_datas_array</span></div>


    <span class="c1"># 顔のエンコーディング</span>
    <span class="c1"># @profile()</span>
    <span class="c1"># @Cal_obj.Measure_func</span>
<div class="viewcode-block" id="Core.face_encoding_process"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.face_encoding_process">[docs]</a>    <span class="k">def</span> <span class="nf">face_encoding_process</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>

        <span class="sd">&quot;&quot;&quot;Encode face data and Return </span>
<span class="sd">            - list of encoded data</span>
<span class="sd">            - frame_datas_array</span>

<span class="sd">        Args:</span>
<span class="sd">            logger (_type_): logger</span>
<span class="sd">            CONFIG (Dict): Dict including initial setting</span>
<span class="sd">            frame_datas_array (List[Dict]): frame datas</span>

<span class="sd">        Returns:</span>
<span class="sd">            - list of encoded data</span>
<span class="sd">                - Tuple[List[npt.NDArray[np.float64]]</span>
<span class="sd">            - frame_datas_array</span>
<span class="sd">                - List[Dict]]</span>
<span class="sd">        </span>
<span class="sd">        Definition of person_data_list and frame_datas_array:</span>
<span class="sd">            person_data = {</span>
<span class="sd">                    &#39;name&#39;: name,</span>
<span class="sd">                    &#39;pict&#39;:filename,</span>
<span class="sd">                    &#39;date&#39;:date,</span>
<span class="sd">                    &#39;location&#39;:(top,right,bottom,left),</span>
<span class="sd">                    &#39;percentage_and_symbol&#39;: percentage_and_symbol</span>
<span class="sd">                }</span>
<span class="sd">            person_data_list.append(person_data)</span>

<span class="sd">            frame_datas = {</span>
<span class="sd">                    &#39;img&#39;: resized_frame,</span>
<span class="sd">                    &#39;face_location_list&#39;: face_location_list,</span>
<span class="sd">                    &#39;overlay&#39;: overlay,</span>
<span class="sd">                    &#39;person_data_list&#39;: person_data_list</span>
<span class="sd">                }</span>
<span class="sd">            frame_datas_array.append(frame_datas)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_datas_array</span>

        <span class="n">face_encodings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># face_encodings_list = []  # Not used.</span>

        <span class="k">for</span> <span class="n">frame_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="p">:</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
            <span class="n">face_location_list</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;face_location_list&quot;</span><span class="p">]</span>  <span class="c1"># [(139, 190, 257, 72)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 顔がない場合</span>
                <span class="k">return</span> <span class="n">face_encodings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 顔がある場合</span>

                <span class="c1"># 顔ロケーションからエンコーディングを求める</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;use_pipe&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;person_frame_face_encoding&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot;FIX</span>
<span class="sd">                    人数分を繰り返し処理しているので時間がかかる。</span>
<span class="sd">                    dlibは一つの画像に複数の座標を与えて一度に処理をする。</span>
<span class="sd">                    なので各person_frameをくっつけて一つの画像にすれば処理時間は短くなる。</span>
<span class="sd">                        numpy.hstack(tup)[source]</span>
<span class="sd">                        Stack arrays in sequence horizontally (column wise).</span>
<span class="sd">                        https://numpy.org/doc/stable/reference/generated/numpy.hstack.html</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="n">concatenate_face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span>
                    <span class="n">concatenate_person_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span>

                    <span class="n">concatenate_face_location_list</span><span class="p">,</span> <span class="n">concatenate_person_frame</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">return_concatenate_location_and_frame</span><span class="p">(</span>
                            <span class="n">resized_frame</span><span class="p">,</span>
                            <span class="n">face_location_list</span>
                        <span class="p">)</span>
                    <span class="n">face_encodings</span> <span class="o">=</span> \
                        <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span>
                            <span class="n">concatenate_person_frame</span><span class="p">,</span>
                            <span class="n">concatenate_face_location_list</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;jitters&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;small&quot;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;use_pipe&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;person_frame_face_encoding&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">face_encodings</span> <span class="o">=</span> \
                            <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span>
                                <span class="n">resized_frame</span><span class="p">,</span>
                                <span class="n">face_location_list</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;jitters&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;small&quot;</span>
                            <span class="p">)</span>
                        <span class="c1"># TODO: #34 use_pipe = TrueとFalseによる&#39;face_encodings&#39;の処理速度の違いを究明する</span>
                        <span class="c1"># if face_encodings == []:</span>
                        <span class="c1">#     return face_encodings, self.frame_datas_array</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resized_frame: </span><span class="si">{</span><span class="n">resized_frame</span><span class="si">}</span><span class="se">\n</span><span class="s1">face_location_list:  </span><span class="si">{</span><span class="n">face_location_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ERROR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;use_pipe&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;person_frame_face_encoding&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;config.ini:&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You cannot set person_frame_face_encoding = True if use_pipe = False&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Change the settings appropriately&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;use_pipe&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;person_frame_face_encoding&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">face_encodings</span> <span class="o">=</span> \
                        <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span>
                            <span class="n">resized_frame</span><span class="p">,</span>
                            <span class="n">face_location_list</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;jitters&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;small&quot;</span>
                        <span class="p">)</span>
                
                <span class="c1"># face_encodings_list = face_encodings_list.append(face_encodings)</span>
        <span class="c1"># yield face_encodings, self.frame_datas_array</span>
        <span class="k">return</span> <span class="n">face_encodings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span></div>

    <span class="c1"># 顔の生データ(np.ndarray)を返す</span>
    <span class="sd">&quot;&quot;&quot;How to slice</span>
<span class="sd">    face_location order: top, right, bottom, left</span>
<span class="sd">    how to slice: img[top:bottom, left:right]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># def return_face_image(</span>
    <span class="c1">#     self,</span>
    <span class="c1">#     resized_frame,</span>
    <span class="c1">#     face_location</span>
    <span class="c1"># ):</span>
    <span class="c1">#     self.resized_frame = resized_frame</span>
    <span class="c1">#     empty_ndarray = np.empty(shape=(0,0,0), dtype=np.uint8)</span>

    <span class="c1">#     if len(self.face_location) &gt; 0:</span>
    <span class="c1">#         top = face_location[0]</span>
    <span class="c1">#         right = face_location[1]</span>
    <span class="c1">#         bottom = face_location[2]</span>
    <span class="c1">#         left = face_location[3]</span>
    <span class="c1">#         face_image = self.resized_frame[top:bottom, left:right]</span>
    <span class="c1">#         &quot;&quot;&quot;DEBUG</span>
    <span class="c1">#         from .video_capture import VidCap</span>
    <span class="c1">#         VidCap().frame_imshow_for_debug(face_image)</span>
    <span class="c1">#         VidCap().frame_imshow_for_debug(self.resized_frame)</span>
    <span class="c1">#         &quot;&quot;&quot;</span>
    <span class="c1">#         return face_image</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return empty_ndarray</span>


    <span class="c1"># フレーム後処理</span>
    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.frame_post_processing"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.frame_post_processing">[docs]</a>    <span class="k">def</span> <span class="nf">frame_post_processing</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">face_encodings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
            <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Modify each frame&#39;s datas.</span>

<span class="sd">        Args:</span>
<span class="sd">            logger (_type_): logger</span>
<span class="sd">            CONFIG (Dict): Dict of initial settings</span>
<span class="sd">            face_encodings (List[npt.NDArray[np.float64]]): List of encoded face datas</span>
<span class="sd">            frame_datas_array (List[Dict]): List of datas</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict]: List of modified datas</span>

<span class="sd">        Modify:</span>
<span class="sd">            - Composite images</span>
<span class="sd">                - Default face image</span>
<span class="sd">                - Rectangle</span>
<span class="sd">                - Percentage</span>
<span class="sd">                - Name</span>
<span class="sd">            - Percentage calculation</span>
<span class="sd">            - Save cropped face images</span>
<span class="sd">            - Make person_data_list</span>
<span class="sd">            - Make frame_datas_list</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">face_encodings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_datas_array</span>
        <span class="n">face_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">face_location_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># debug_frame_turn_count = 0  # Not use</span>
        <span class="n">modified_frame_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># frame_datas_arrayについて一度づつ回す</span>
        <span class="k">for</span> <span class="n">frame_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_datas_array</span><span class="p">:</span>

            <span class="c1"># frame_dataにface_location_listがなければ処理をとばす</span>
            <span class="k">if</span> <span class="s2">&quot;face_location_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># 半透明処理（後半）_1frameに対して1回</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;show_overlay&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span>
                            <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;overlay&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                            <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">],</span>
                            <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
            <span class="n">face_location_list</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;face_location_list&quot;</span><span class="p">]</span>
            <span class="n">overlay</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;overlay&quot;</span><span class="p">]</span>
            <span class="n">person_data_list</span> <span class="o">=</span> <span class="n">frame_data</span><span class="p">[</span><span class="s2">&quot;person_data_list&quot;</span><span class="p">]</span>  <span class="c1"># person_data_listが変数に格納される</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y,%m,</span><span class="si">%d</span><span class="s2">,%H,%M,%S,</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">face_encoding</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
            <span class="n">matches</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">]</span>
            <span class="n">min_distance</span><span class="p">:</span> <span class="nb">float</span>

            <span class="c1"># 名前リスト作成</span>
            <span class="k">for</span> <span class="n">face_encoding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">:</span>
                <span class="c1"># Initialize name, matches (Inner frame)</span>
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

                <span class="n">matches</span><span class="p">,</span> <span class="n">min_distance</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_check_compare_faces</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;known_face_encodings&quot;</span><span class="p">],</span>
                                <span class="n">face_encoding</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">]</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>  <span class="c1"># If there is no such person</span>
                    <span class="n">face_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Set &quot;Unknown&quot;</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># If there is an applicable person</span>
                    <span class="n">face_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_face_name</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span>
                        <span class="n">matches</span><span class="p">,</span>
                        <span class="n">min_distance</span>
                    <span class="p">)</span>
                <span class="n">face_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_name</span><span class="p">)</span>  <span class="c1"># set the person&#39;s name</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># face_location_listについて繰り返し処理 → **frame_datas_array**作成</span>
            <span class="c1">## つまり人が写っているframeだけに対して以降の処理を行う、ということ。</span>
            <span class="n">number_of_people</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 人数。計算上0人から始める。draw_default_face()で使用する</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">face_location_list</span><span class="p">,</span> <span class="n">face_names</span><span class="p">):</span>
                <span class="c1"># person_data = defaultdict(int)  # defaultdict(): k(eyの存在チェックが不要)[https://qiita.com/xza/items/72a1b07fcf64d1f4bdb7]</span>
                <span class="c1"># person_data = {}</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                    <span class="n">percentage_and_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">dis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="c1"># nameが誰かの名前の場合、以下の処理を行う。</span>
                <span class="k">else</span><span class="p">:</span>  
                    <span class="n">distance</span><span class="p">:</span> <span class="nb">str</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="c1"># パーセンテージの算出</span>
                    <span class="n">dis</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="c1"># return_percentage(p)</span>
                    <span class="n">percentage</span> <span class="o">=</span> <span class="n">Cal_obj</span><span class="o">.</span><span class="n">return_percentage</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">percentage</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">percentage</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">percentage_and_symbol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
                    <span class="c1"># ファイル名を最初のアンダーバーで区切る（アンダーバーは複数なのでmaxsplit = 1）</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">maxsplit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ファイル名に異常が見つかりました&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;NAME_default.png あるいはNAME_001.png (001部分は001からはじまる連番)にしてください&#39;</span><span class="p">,</span><span class="s1">&#39;noFaceフォルダに移動します&#39;</span><span class="p">)</span>
                        <span class="n">move</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;./noFace/&#39;</span><span class="p">)</span>
                        <span class="c1"># return</span>
                        <span class="k">continue</span>

                <span class="c1"># nameがUnknownであってもなくても以降の処理を行う。</span>
                <span class="c1"># クロップ画像保存</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;crop_face_image&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;frequency_crop_image&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_crops&quot;</span><span class="p">]:</span>
                        <span class="n">pil_img_obj_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pil_img_rgb_instance</span><span class="p">(</span><span class="n">resized_frame</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;crop_with_multithreading&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="c1"># &quot;&quot;&quot;1.3.08 multithreading 9.05s</span>
                            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_crop_face_image</span><span class="p">,</span> 
                                    <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;anti_spoof&quot;</span><span class="p">],</span>
                                    <span class="n">name</span><span class="p">,</span>
                                    <span class="n">dis</span><span class="p">,</span>
                                    <span class="n">pil_img_obj_rgb</span><span class="p">,</span>
                                    <span class="n">top</span><span class="p">,</span>
                                    <span class="n">left</span><span class="p">,</span>
                                    <span class="n">right</span><span class="p">,</span>
                                    <span class="n">bottom</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_crops&quot;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;frequency_crop_image&quot;</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="n">filename</span><span class="p">,</span><span class="n">number_of_crops</span><span class="p">,</span> <span class="n">frequency_crop_image</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                            <span class="c1"># &quot;&quot;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># &quot;&quot;&quot;ORIGINAL: 1.3.08で変更 8.69s</span>
                            <span class="n">filename</span><span class="p">,</span><span class="n">number_of_crops</span><span class="p">,</span> <span class="n">frequency_crop_image</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_make_crop_face_image</span><span class="p">(</span>
                                    <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;anti_spoof&quot;</span><span class="p">],</span>
                                    <span class="n">name</span><span class="p">,</span>
                                    <span class="n">dis</span><span class="p">,</span>
                                    <span class="n">pil_img_obj_rgb</span><span class="p">,</span>
                                    <span class="n">top</span><span class="p">,</span>
                                    <span class="n">left</span><span class="p">,</span>
                                    <span class="n">right</span><span class="p">,</span>
                                    <span class="n">bottom</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_crops&quot;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;frequency_crop_image&quot;</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="c1"># &quot;&quot;&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_crops&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;number_of_crops&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># 描画系</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

                    <span class="c1"># デフォルト顔画像の描画</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">]:</span>  <span class="c1"># ディスタンスpがtolerance以下の場合</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;default_face_image_draw&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_draw_default_face</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span>
                                    <span class="n">name</span><span class="p">,</span>
                                    <span class="n">resized_frame</span><span class="p">,</span>
                                    <span class="n">number_of_people</span>
                                <span class="p">)</span>
                            <span class="n">number_of_people</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 何人目か</span>
                            <span class="sd">&quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
                            <span class="c1"># frame_imshow_for_debug(resized_frame)</span>

                    <span class="c1"># ピンクまたは白の四角形描画</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rectangle&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>  <span class="c1"># プリセット顔画像に対応する顔画像がなかった場合</span>
                            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_pink_rectangle</span><span class="p">(</span><span class="n">resized_frame</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span><span class="n">bottom</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># プリセット顔画像に対応する顔画像があった場合</span>
                            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_draw_white_rectangle</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rectangle&quot;</span><span class="p">],</span>
                                    <span class="n">resized_frame</span><span class="p">,</span>
                                    <span class="n">top</span><span class="p">,</span>
                                    <span class="n">left</span><span class="p">,</span>
                                    <span class="n">right</span><span class="p">,</span>
                                    <span class="n">bottom</span>
                                <span class="p">)</span>
                        
                    <span class="c1"># パーセンテージ描画</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;show_percentage&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_display_percentage</span><span class="p">(</span>
                                <span class="n">percentage_and_symbol</span><span class="p">,</span>
                                <span class="n">resized_frame</span><span class="p">,</span>
                                <span class="n">p</span><span class="p">,</span>
                                <span class="n">left</span><span class="p">,</span>
                                <span class="n">right</span><span class="p">,</span>
                                <span class="n">bottom</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="sd">&quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
                        <span class="c1"># frame_imshow_for_debug(resized_frame)</span>

                    <span class="c1"># 名前表示と名前用四角形の描画</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;show_name&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_rectangle_for_name</span><span class="p">(</span>
                                <span class="n">name</span><span class="p">,</span>
                                <span class="n">resized_frame</span><span class="p">,</span>
                                <span class="n">left</span><span class="p">,</span>
                                <span class="n">right</span><span class="p">,</span><span class="n">bottom</span>
                            <span class="p">)</span>
                        <span class="n">pil_img_obj</span><span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">resized_frame</span><span class="p">)</span>
                        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_text_for_name</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                                <span class="n">left</span><span class="p">,</span>
                                <span class="n">right</span><span class="p">,</span>
                                <span class="n">bottom</span><span class="p">,</span>
                                <span class="n">name</span><span class="p">,</span>
                                <span class="n">p</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">],</span>
                                <span class="n">pil_img_obj</span>
                            <span class="p">)</span>
                        <span class="sd">&quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
                        <span class="c1"># frame_imshow_for_debug(resized_frame)</span>

                    <span class="c1"># target_rectangleの描画</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;target_rectangle&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_target_rectangle</span><span class="p">(</span>
                                <span class="n">person_data_list</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">,</span>
                                <span class="n">resized_frame</span><span class="p">,</span>
                                <span class="n">top</span><span class="p">,</span>
                                <span class="n">bottom</span><span class="p">,</span>
                                <span class="n">left</span><span class="p">,</span>
                                <span class="n">right</span><span class="p">,</span>
                                <span class="n">name</span>
                            <span class="p">)</span>
                        <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">                        frame_imshow_for_debug(resized_frame)</span>
<span class="sd">                        &quot;&quot;&quot;</span>

                <span class="n">person_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;pict&#39;</span><span class="p">:</span><span class="n">filename</span><span class="p">,</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="n">date</span><span class="p">,</span>
                    <span class="s1">&#39;location&#39;</span><span class="p">:(</span><span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span>
                    <span class="s1">&#39;percentage_and_symbol&#39;</span><span class="p">:</span> <span class="n">percentage_and_symbol</span>
                <span class="p">}</span>
                <span class="n">person_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person_data</span><span class="p">)</span>

                <span class="c1"># self.frame_datas_array = \</span>
                <span class="c1">#     self.make_frame_datas_array(</span>
                <span class="c1">#         overlay,</span>
                <span class="c1">#         face_location_list,</span>
                <span class="c1">#         name,</span>
                <span class="c1">#         filename,</span>
                <span class="c1">#         percentage_and_symbol,</span>
                <span class="c1">#         person_data_list,</span>
                <span class="c1">#         frame_datas_array,</span>
                <span class="c1">#         resized_frame </span>
                <span class="c1">#     )</span>
            <span class="c1"># End for (top, right, bottom, left), name in zip(face_location_list, face_names)</span>

            <span class="c1"># _1frameに対して1回 &lt;- ?</span>
            <span class="c1">## 人が写っているframeをforで回している途中です。</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">frame_datas</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;img&#39;</span><span class="p">:</span><span class="n">resized_frame</span><span class="p">,</span>
                    <span class="s1">&#39;face_location_list&#39;</span><span class="p">:</span><span class="n">face_location_list</span><span class="p">,</span>
                    <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
                    <span class="s1">&#39;person_data_list&#39;</span><span class="p">:</span> <span class="n">person_data_list</span>
                <span class="p">}</span>
                <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">                frame_imshow_for_debug(resized_frame)</span>
<span class="sd">                self.frame_datas_array.append(frame_datas)</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">modified_frame_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_datas</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">frame_datas</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;img&#39;</span><span class="p">:</span><span class="n">resized_frame</span><span class="p">,</span>
                    <span class="s1">&#39;face_location_list&#39;</span><span class="p">:</span><span class="n">face_location_list</span><span class="p">,</span>
                    <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
                    <span class="s1">&#39;person_data_list&#39;</span><span class="p">:</span> <span class="n">person_data_list</span>
                <span class="p">}</span>
                <span class="c1"># self.frame_datas_array.append(frame_datas)</span>
                <span class="n">modified_frame_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_datas</span><span class="p">)</span>
            <span class="c1"># else:  # この処理はどうして書いたのか？不明。</span>
            <span class="c1">#     frame_datas = {&#39;img&#39;:resized_frame, &#39;face_location_list&#39;:face_location_list, &#39;overlay&#39;: overlay, &#39;person_data_list&#39;: &#39;no-data_person_data_list&#39;} </span>
            <span class="c1">#     # self.frame_datas_array.append(frame_datas)</span>
            <span class="c1">#     modified_frame_list.append(frame_datas)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;headless&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># 半透明処理（後半）_1frameに対して1回</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;show_overlay&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># cv2.addWeighted(overlay, self.CONFIG[&quot;alpha&quot;], resized_frame, 1-self.CONFIG[&quot;alpha&quot;], 0, resized_frame)</span>
                    <span class="k">for</span> <span class="n">modified_frame</span> <span class="ow">in</span> <span class="n">modified_frame_list</span><span class="p">:</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span>
                            <span class="n">modified_frame</span><span class="p">[</span><span class="s2">&quot;overlay&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">modified_frame</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">modified_frame</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># &quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
                    <span class="c1"># frame_imshow_for_debug(resized_frame)</span>
            
        <span class="c1"># return frame_datas</span>
        <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">        print(f&quot;modified_frame_list.__sizeof__(): {modified_frame_list.__sizeof__()}MB&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">modified_frame_list</span></div>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.r_face_image"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.r_face_image">[docs]</a>    <span class="k">def</span> <span class="nf">r_face_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">face_location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return face image which expressed for ndarray</span>

<span class="sd">        Args:</span>
<span class="sd">            frame (npt.NDArray[np.uint8]): Frame image</span>
<span class="sd">            face_location (Tuple[int,int,int,int]): Face location (coordinate)</span>

<span class="sd">        Returns:</span>
<span class="sd">            npt.NDArray[np.uint8]: Face image which expressed for ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_location</span>
        <span class="n">face_image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">Return_face_image_obj</span><span class="o">.</span><span class="n">return_face_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_location</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">face_image</span></div>


    <span class="c1"># @profile()</span>
<div class="viewcode-block" id="Core.return_anti_spoof"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.return_anti_spoof">[docs]</a>    <span class="k">def</span> <span class="nf">return_anti_spoof</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">face_location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return result of anti spoof</span>

<span class="sd">        Args:</span>
<span class="sd">            frame (npt.NDArray[np.uint8]): Each of frame</span>
<span class="sd">            face_location (Tuple[int,int,int,int]): Face location</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, float, bool]: </span>
<span class="sd">            - spoof_or_real</span>
<span class="sd">            - score</span>
<span class="sd">            - ELE</span>
<span class="sd">                - Equally Likely Events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_location</span>
        <span class="n">face_image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_face_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_location</span><span class="p">)</span>
        <span class="c1"># face_image = Return_face_image_obj.return_face_image(self.frame, self.face_location)</span>
        <span class="c1"># face_image = self.return_face_image(self.frame, self.face_location)</span>
        <span class="c1"># VidCap_obj.frame_imshow_for_debug(face_image)  # DEBUG</span>

        <span class="sd">&quot;&quot;&quot; DEBUG: face_image確認 -&gt; 正方形であることを確認した</span>
<span class="sd">        print(self.face_location)</span>
<span class="sd">        cv2.imshow(&#39;Core: DEBUG&#39;, face_image)</span>
<span class="sd">        cv2.waitKey(3000)</span>
<span class="sd">        cv2.destroyAllWindows()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 定形処理:リサイズ, 標準化, 成形, float32キャスト, 推論, 後処理</span>
        <span class="n">input_image</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Mat</span> <span class="o">=</span> \
            <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">face_image</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
        <span class="c1"># VidCap_obj.frame_imshow_for_debug(input_image)</span>

        <span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>

        <span class="c1"># 推論</span>
        <span class="n">input_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">onnx_session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">onnx_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="n">input_name</span><span class="p">:</span> <span class="n">input_image</span><span class="p">})</span>    <span class="c1"># type: ignore</span>
        
        <span class="c1"># 後処理</span>
        <span class="n">result_ndarray</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result_squeeze</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result_ndarray</span><span class="p">)</span>

        <span class="n">as_index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result_squeeze</span><span class="p">)</span>

        <span class="n">score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_squeeze</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ELE</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
            <span class="n">ELE</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">spoof_or_real</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">as_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># (255, 0, 0)</span>
            <span class="c1"># spoof_or_real = &#39;real&#39;</span>
            <span class="n">spoof_or_real</span> <span class="o">=</span> <span class="s1">&#39;spoof&#39;</span>
            <span class="k">return</span> <span class="n">spoof_or_real</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ELE</span>
        <span class="k">if</span> <span class="n">as_index</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="c1"># else:</span>
            <span class="c1"># spoof_or_real = &#39;spoof&#39;</span>
            <span class="n">spoof_or_real</span> <span class="o">=</span> <span class="s1">&#39;real&#39;</span>
            <span class="k">return</span> <span class="n">spoof_or_real</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ELE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spoof_or_real</span> <span class="o">=</span> <span class="s1">&#39;cannot_distinction&#39;</span>
            <span class="k">return</span> <span class="n">spoof_or_real</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ELE</span></div>


<span class="c1"># 以下、元libdraw.LibDraw</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_pink_rectangle</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">top</span><span class="p">,</span>
            <span class="n">bottom</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">243</span><span class="p">),</span>
            <span class="mi">2</span>
        <span class="p">)</span> <span class="c1"># pink</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_white_rectangle</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">rectangle</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">top</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span>
            <span class="n">bottom</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangle</span> <span class="o">=</span> <span class="n">rectangle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">-</span><span class="mi">18</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">18</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="o">+</span><span class="mi">18</span><span class="p">),</span> <span class="p">(</span><span class="mi">175</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">175</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 灰色内枠</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">-</span><span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="o">+</span><span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 白色外枠</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>


    <span class="c1"># パーセンテージ表示</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_display_percentage</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">percentage_and_symbol</span><span class="p">,</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">p</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span>
            <span class="n">bottom</span><span class="p">,</span>
            <span class="n">tolerance</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_and_symbol</span> <span class="o">=</span> <span class="n">percentage_and_symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX_SMALL</span>
        <span class="c1"># パーセンテージ表示用の灰色に塗りつぶされた四角形の描画</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="mi">75</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="o">+</span><span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span> <span class="c1"># 灰色</span>
        <span class="c1"># テキスト表示位置</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="n">putText_center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">25</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">25</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">putText_chaCenter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">putText_pos</span> <span class="o">=</span> <span class="n">putText_center</span> <span class="o">-</span> <span class="p">(</span><span class="n">putText_chaCenter</span><span class="o">*</span><span class="n">fontsize</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">putText_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">putText_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="mi">75</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># toleranceの値によってフォント色を変える</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
            <span class="c1"># パーセンテージを白文字表示</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_and_symbol</span><span class="p">,</span> <span class="n">putText_position</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># パーセンテージをピンク表示</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_and_symbol</span><span class="p">,</span> <span class="n">putText_position</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">243</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>


    <span class="c1"># デフォルト顔画像の描画処理</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_default_face_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">default_face_small_image</span><span class="p">,</span>
            <span class="n">x1</span><span class="p">,</span>
            <span class="n">y1</span><span class="p">,</span>
            <span class="n">x2</span><span class="p">,</span>
            <span class="n">y2</span><span class="p">,</span>
            <span class="n">number_of_people</span><span class="p">,</span>
            <span class="n">face_image_width</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_face_small_image</span> <span class="o">=</span> <span class="n">default_face_small_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_image_width</span> <span class="o">=</span> <span class="n">face_image_width</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_image_width</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_image_width</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_face_small_image</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_face_small_image</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">default_face_small_image</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
            <span class="c1"># resized_frame[y1:y2, x1:x2] = resized_frame[y1:y2, x1:x2] * a + b  # ValueError: assignment destination is read-only</span>
            <span class="sd">&quot;&quot;&quot;DEBUG&quot;&quot;&quot;</span>
            <span class="c1"># frame_imshow_for_debug(resized_frame)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;デフォルト顔画像の描画が出来ません&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;描画面積が足りないか他に問題があります&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>

    <span class="c1"># デフォルト顔画像の表示面積調整</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_adjust_display_area</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">,</span>
            <span class="n">default_face_image</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_face_image</span> <span class="o">=</span> <span class="n">default_face_image</span>
        <span class="sd">&quot;&quot;&quot;TODO</span>
<span class="sd">        繰り返し計算させないようリファクタリング&quot;&quot;&quot;</span>
        <span class="n">face_image_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;set_width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">default_face_small_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_face_image</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="n">face_image_width</span><span class="p">,</span> <span class="n">face_image_width</span><span class="p">))</span>  <span class="c1"># 幅・高さともに同じとする</span>
        <span class="c1"># 高さ = face_image_width</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;set_height&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">face_image_width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">face_image_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;set_height&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">default_face_small_image</span><span class="p">,</span> <span class="n">face_image_width</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_default_face</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">number_of_people</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span>
        <span class="n">default_face_image_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;default_face_image_dict&quot;</span><span class="p">]</span>

        <span class="n">default_name_png</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_default.png&#39;</span>
        <span class="n">default_face_image_name_png</span> <span class="o">=</span> <span class="s1">&#39;./priset_face_images/&#39;</span> <span class="o">+</span> <span class="n">default_name_png</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">default_face_image_dict</span><span class="p">:</span>  <span class="c1"># default_face_image_dictにnameが存在しなかった場合</span>
            <span class="c1"># 各人物のデフォルト顔画像ファイルの読み込み</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">default_face_image_name_png</span><span class="p">):</span>
                <span class="c1"># WINDOWSのopencv-python4.2.0.32ではcv2.imread()でpng画像を読み込めないバグが</span>
                <span class="c1"># 存在する可能性があると思う。そこでPNG画像の読み込みにはpillowを用いることにする</span>
                <span class="n">default_face_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">default_face_image_name_png</span><span class="p">))</span>
                <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">                frame_imshow_for_debug(default_face_image)</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># BGAをRGBへ変換</span>
                <span class="n">default_face_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">default_face_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGBA</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">                frame_imshow_for_debug(default_face_image)</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># if default_face_image.ndim == 3:  # RGBならアルファチャンネル追加 resized_frameがアルファチャンネルを持っているから。</span>
                <span class="c1"># default_face_imageをメモリに保持</span>
                <span class="n">default_face_image_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_face_image</span>  <span class="c1"># キーnameと値default_face_imageの組み合わせを挿入する</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">さんのデフォルト顔画像ファイルがpriset_face_imagesフォルダに存在しません&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">さんのデフォルト顔画像ファイルをpriset_face_imagesフォルダに用意してください&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># default_face_image_dictにnameが存在した場合</span>
            <span class="n">default_face_image</span> <span class="o">=</span> <span class="n">default_face_image_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># キーnameに対応する値をdefault_face_imageへ格納する</span>
            <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">            frame_imshow_for_debug(default_face_image)  # OK</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="p">,</span> <span class="n">default_face_small_image</span><span class="p">,</span> <span class="n">face_image_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_display_area</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">default_face_image</span><span class="p">)</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_default_face_image</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">resized_frame</span><span class="p">,</span> <span class="n">default_face_small_image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">number_of_people</span><span class="p">,</span> <span class="n">face_image_width</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resized_frame</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_rectangle_for_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span><span class="n">bottom</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>   <span class="c1"># nameがUnknownだった場合</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="mi">25</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="o">+</span><span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">243</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span> <span class="c1"># pink</span>
        <span class="k">else</span><span class="p">:</span>                   <span class="c1"># nameが既知だった場合</span>
            <span class="c1"># cv2.rectangle(resized_frame, (left-25, bottom + 25), (right+25, bottom+50), (211, 173, 54), thickness = 1) # 濃い水色の線</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="mi">25</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="o">+</span><span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="mi">211</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">54</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span> <span class="c1"># 濃い水色</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>


    <span class="c1"># 帯状四角形（ピンク）の描画</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_error_messg_rectangle</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
            <span class="n">set_height</span><span class="p">,</span>
            <span class="n">set_width</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;廃止予定</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span> <span class="o">=</span> <span class="n">set_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span> <span class="o">=</span> <span class="n">set_width</span>
        <span class="n">error_messg_rectangle_top</span><span class="p">:</span> <span class="nb">int</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">set_height</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">error_messg_rectangle_bottom</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">set_height</span> <span class="o">+</span> <span class="mi">120</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">error_messg_rectangle_left</span><span class="p">:</span> <span class="nb">int</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_messg_rectangle_right</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_width</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">error_messg_rectangle_left</span><span class="p">,</span> <span class="n">error_messg_rectangle_top</span><span class="p">),</span> <span class="p">(</span><span class="n">error_messg_rectangle_right</span><span class="p">,</span> <span class="n">error_messg_rectangle_bottom</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">243</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>  <span class="c1"># pink</span>
        <span class="k">return</span> <span class="n">error_messg_rectangle_left</span><span class="p">,</span> <span class="n">error_messg_rectangle_right</span><span class="p">,</span> <span class="n">error_messg_rectangle_bottom</span>


    <span class="c1"># drawオブジェクトを生成</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span>  <span class="nf">_make_draw_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">draw</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_error_messg_rectangle_messg</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">draw</span><span class="p">,</span>
            <span class="n">error_messg_rectangle_position</span><span class="p">,</span>
            <span class="n">error_messg_rectangle_messg</span><span class="p">,</span>
            <span class="n">error_messg_rectangle_font</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;廃止予定</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw</span> <span class="o">=</span> <span class="n">draw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_position</span> <span class="o">=</span> <span class="n">error_messg_rectangle_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_messg</span> <span class="o">=</span> <span class="n">error_messg_rectangle_messg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_font</span> <span class="o">=</span> <span class="n">error_messg_rectangle_font</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_messg</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_messg_rectangle_font</span><span class="p">)</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_return_fontpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="c1"># フォントの設定(フォントファイルのパスと文字の大きさ)</span>
        <span class="n">operating_system</span><span class="p">:</span> <span class="nb">str</span>  <span class="o">=</span> <span class="n">system</span><span class="p">()</span>
        <span class="n">fontpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">operating_system</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">):</span>
            <span class="c1"># fontpath = &quot;/home/terms/.local/share/fonts/HackGenNerd_v2.5.3/HackGenNerdConsole-Regular.ttf&quot;</span>
            <span class="c1"># fontpath = &quot;/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc&quot;</span>
            <span class="n">fontpath</span> <span class="o">=</span> <span class="s2">&quot;/usr/share/fonts/truetype/mplus/mplus-1mn-bold.ttf&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">operating_system</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">):</span>
                        <span class="c1"># fontpath = &quot;C:/WINDOWS/FONTS/BIZ-UDGOTHICR.TTC&quot;</span>
            <span class="n">fontpath</span> <span class="o">=</span> <span class="s2">&quot;C:/WINDOWS/FONTS/BIZ-UDGOTHICB.TTC&quot;</span>  <span class="c1">## bold体</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;オペレーティングシステムの確認が出来ません。システム管理者にご連絡ください&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fontpath</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_calculate_text_position</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="p">,</span>
            <span class="n">bottom</span>
        <span class="p">):</span>
        <span class="c1"># TODO: #17 英数字のみの場合の位置決定バグ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">=</span> <span class="n">fontsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>

        <span class="n">center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">chaCenter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="p">(</span><span class="n">chaCenter</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">Unknown_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fontsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">Unknown_position</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span><span class="n">pil_img_obj</span><span class="p">,</span>
            <span class="n">Unknown_position</span><span class="p">,</span>
            <span class="n">font</span><span class="p">,</span>
            <span class="n">p</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="p">,</span>
            <span class="n">position</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span> <span class="o">=</span> <span class="n">pil_img_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Unknown_position</span> <span class="o">=</span> <span class="n">Unknown_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">font</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>

        <span class="n">local_draw_obj</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>  <span class="c1">## nameがUnknownだった場合</span>
            <span class="c1"># draw.text(Unknown_position, &#39;照合不一致&#39;, fill=(255, 255, 255, 255), font = font)</span>
            <span class="c1"># unregistered = mojimoji.han_to_zen(&#39;UNREGISTERED&#39;)</span>
            <span class="c1"># local_draw_obj.text(self.Unknown_position, unregistered, fill=(255, 255, 255, 255), font = self.font)</span>
            <span class="n">local_draw_obj</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Unknown_position</span><span class="p">,</span> <span class="s1">&#39;UNREGISTERED&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
            <span class="c1"># local_draw_obj.text(self.Unknown_position, &#39;　未登録&#39;, fill=(255, 255, 255, 255), font = self.font)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">## nameが既知の場合</span>
            <span class="c1"># if percentage &gt; 99.0:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                <span class="c1"># nameの描画</span>
                <span class="n">local_draw_obj</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_draw_obj</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span>


    <span class="c1"># pil_img_objをnumpy配列に変換</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_convert_pil_img_to_ndarray</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pil_img_obj</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span> <span class="o">=</span> <span class="n">pil_img_obj</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;DEBUG: Memory leak</span>
<span class="sd">        del pil_img_obj</span>
<span class="sd">        gc.collect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame</span>


    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_text_for_name</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">left</span><span class="p">,</span>
            <span class="n">right</span><span class="p">,</span>
            <span class="n">bottom</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">p</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="p">,</span>
            <span class="n">pil_img_obj</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span> <span class="o">=</span> <span class="n">pil_img_obj</span>

        <span class="c1"># すべての文字を全角変換する</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">mojimoji</span><span class="o">.</span><span class="n">han_to_zen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kana</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">digit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fontpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_fontpath</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;TODO #16 FONTSIZEハードコーティング訂正&quot;&quot;&quot;</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">fontpath</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># テキスト表示位置決定</span>
        <span class="n">position</span><span class="p">,</span> <span class="n">Unknown_position</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_text_position</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span>
            <span class="p">)</span>
        <span class="c1"># nameの描画</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span><span class="p">,</span>
                <span class="n">Unknown_position</span><span class="p">,</span>
                <span class="n">font</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
                <span class="n">position</span>
            <span class="p">)</span>
        <span class="c1"># pil_img_objをnumpy配列に変換</span>
        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_pil_img_to_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_img_obj</span><span class="p">)</span>
        <span class="c1"># del self.pil_img_obj</span>
        <span class="k">return</span> <span class="n">resized_frame</span>


    <span class="c1"># target_rectangleの描画</span>
    <span class="c1"># @profile()</span>
    <span class="k">def</span> <span class="nf">_draw_target_rectangle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">person_data_list</span><span class="p">,</span>
        <span class="n">CONFIG</span><span class="p">,</span>
        <span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">],</span>
        <span class="n">top</span><span class="p">,</span>
        <span class="n">bottom</span><span class="p">,</span>
        <span class="n">left</span><span class="p">,</span>
        <span class="n">right</span><span class="p">,</span>
        <span class="n">name</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_data_list</span> <span class="o">=</span> <span class="n">person_data_list</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anti_spoof</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;anti_spoof&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rect01_png&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rect01_NG_png&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rect01_REAL_png&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rect01_SPOOF_png&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;rect01_CANNOT_DISTINCTION_png&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">resized_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">face_location</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>

        <span class="n">width_ratio</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">height_ratio</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">face_width</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">face_height</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">spoof_or_real</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ELE</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anti_spoof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Fix: TODO: この箇所でreturn_anti_spoof()を呼び出すのは重複になる</span>
            <span class="c1"># for person_data in self.person_data_list:</span>
            <span class="c1">#     for person_data_element in person_data:</span>
            <span class="c1">#         if person_data_element == {}:</span>
            <span class="c1">#             continue</span>
            <span class="c1">#         spoof_or_real = person_data_element[&quot;spoof_dict&quot;][&quot;spoof_or_real&quot;]</span>
            <span class="c1">#         score = person_data_element[&quot;spoof_dict&quot;][&quot;score&quot;]</span>
            <span class="c1">#         ELE = person_data_element[&quot;spoof_dict&quot;][&quot;ELE&quot;]</span>
            <span class="c1"># ELE: Equally Likely Events</span>
            <span class="n">spoof_or_real</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ELE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_anti_spoof</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">,</span> <span class="n">face_location</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">spoof_or_real</span> <span class="o">==</span> <span class="s1">&#39;spoof&#39;</span> <span class="ow">and</span> <span class="n">ELE</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">face_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">)</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_SPOOF_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">spoof_or_real</span> <span class="o">==</span> <span class="s1">&#39;cannot_distinction&#39;</span> <span class="ow">and</span> <span class="n">ELE</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">face_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">)</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_CANNOT_DISTINCTION_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">and</span> <span class="n">spoof_or_real</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span> <span class="ow">and</span> <span class="n">ELE</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1">## self.nameが既知の場合</span>
                <span class="n">face_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">)</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_REAL_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">and</span> <span class="n">spoof_or_real</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span> <span class="ow">and</span> <span class="n">ELE</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1">## self.nameがUnknownだった場合</span>
                <span class="n">fx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">face_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="c1"># rect01_NG_png←ピンクのtarget_rectangle</span>
                <span class="c1"># rect01_NG_png: cv2.Mat = cv2.imread(&quot;images/rect01_NG.png&quot;, cv2.IMREAD_UNCHANGED)</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">))</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">anti_spoof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># BUG FIX: v1.4.04</span>
            <span class="n">ELE</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>  <span class="c1">## self.nameが既知の場合</span>
                <span class="n">face_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">)</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>  <span class="c1">## self.nameがUnknownだった場合</span>
                <span class="n">fx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">face_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
                <span class="n">face_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
                <span class="c1"># rect01_NG_png←ピンクのtarget_rectangle</span>
                <span class="c1"># rect01_NG_png: cv2.Mat = cv2.imread(&quot;images/rect01_NG.png&quot;, cv2.IMREAD_UNCHANGED)</span>
                <span class="n">orgHeight</span><span class="p">,</span> <span class="n">orgWidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">width_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_width</span> <span class="o">/</span> <span class="n">orgWidth</span><span class="p">))</span>
                <span class="n">height_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">face_height</span> <span class="o">/</span> <span class="n">orgHeight</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">width_ratio</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">height_ratio</span><span class="p">)</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect01_NG_png</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># TODO: np.clip</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resized_frame</span>


<div class="viewcode-block" id="Core.common_process"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.common_process">[docs]</a>    <span class="k">def</span> <span class="nf">common_process</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;Generator of frame_datas_array</span>

<span class="sd">        Yields:</span>
<span class="sd">            Generator: frame_datas_array</span>
<span class="sd">                - frame_datas_array: List[Dict]</span>
<span class="sd">        </span>
<span class="sd">        More about:</span>
<span class="sd">            main_process function consists 3 part of Core() methods.</span>
<span class="sd">            1) Core().frame_pre_processing</span>
<span class="sd">            2) Core().face_encoding_process</span>
<span class="sd">            3) Core().frame_post_processing</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            Make generator object</span>
<span class="sd">            &gt;&gt;&gt; obj = Core().common_process(CONFIG)</span>
<span class="sd">            Call &#39;__next__()&#39; method</span>
<span class="sd">            &gt;&gt;&gt; while True:</span>
<span class="sd">                        frame_datas_array = obj.__next__()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">CONFIG</span>

        <span class="n">frame_generator_obj</span> <span class="o">=</span> <span class="n">VidCap_obj</span><span class="o">.</span><span class="n">frame_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFIG</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">frame_datas_array</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">frame_pre_processing</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                        <span class="n">CONFIG</span><span class="p">,</span>
                        <span class="n">frame_generator_obj</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
                    <span class="p">)</span>
                
                <span class="sd">&quot;&quot;&quot;DEBUG</span>
<span class="sd">                self.logger.debug(inspect.currentframe().f_back.f_code.co_filename)</span>
<span class="sd">                self.logger.debug(inspect.currentframe().f_back.f_lineno)</span>
<span class="sd">                self.logger.debug(f&#39;frame_datas_array size: {len(frame_datas_array), getsizeof(frame_datas_array)}&#39;)</span>
<span class="sd">                self.logger.debug(inspect.currentframe().f_back.f_code.co_filename)</span>
<span class="sd">                self.logger.debug(inspect.currentframe().f_back.f_lineno)</span>
<span class="sd">                self.logger.debug(f&#39;CONFIG size: {len(CONFIG), getsizeof(CONFIG)}&#39;)</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">face_encodings</span><span class="p">,</span> <span class="n">frame_datas_array</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">face_encoding_process</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                        <span class="n">CONFIG</span><span class="p">,</span>
                        <span class="n">frame_datas_array</span>
                    <span class="p">)</span>

                <span class="n">frame_datas_array</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">frame_post_processing</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                        <span class="n">CONFIG</span><span class="p">,</span>
                        <span class="n">face_encodings</span><span class="p">,</span>
                        <span class="n">frame_datas_array</span>
                    <span class="p">)</span>
                
                <span class="k">yield</span> <span class="n">frame_datas_array</span>

            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DATA RECEPTION HAS ENDED&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ERROR OCURRED&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR TYPE: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Core.override_args_dict"><a class="viewcode-back" href="../../face01lib.html#face01lib.Core.Core.override_args_dict">[docs]</a>    <span class="k">def</span> <span class="nf">override_args_dict</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">CONFIG</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">override_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

        <span class="sd">&quot;&quot;&quot;Override CONFIG for example</span>

<span class="sd">        Args:</span>
<span class="sd">            Dict: CONFIG</span>
<span class="sd">            List[Tuple]: override_list</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict: CONFIG</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; CONFIG = Core.override_args_dict(</span>
<span class="sd">                CONFIG,</span>
<span class="sd">                [</span>
<span class="sd">                    (&#39;crop_face_image&#39;, False),</span>
<span class="sd">                    (&#39;output_debug_log&#39;, True)</span>
<span class="sd">                ]</span>
<span class="sd">            )</span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            - *THIS METHOD IS EXPERIMENTAL*</span>
<span class="sd">                - Unexpected side effects may occur.</span>
<span class="sd">            - If you specified key is not exist, application will fail down </span>
<span class="sd">                with print out log &#39;warning&#39;.</span>
<span class="sd">            - You cannot change key &#39;headless&#39;. If override it, application will fall down.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;override&#39; method is EXPERIMENTAL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unexpected side effects may occur&quot;</span><span class="p">)</span>
        
        <span class="n">element</span><span class="p">:</span> <span class="n">Tuple</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">override_list</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">element</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> dose not exist&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;headless&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You cannot change key &#39;headless&#39; from True to False.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;exit&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>

            <span class="n">CONFIG</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="k">return</span> <span class="n">CONFIG</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, yKesamaru.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>